@model projekt.ViewModels.DanieViewModel


@{
    ViewData["Title"] = "Create";
    
}
<style>
    .wlasciwosclisty {
        width: 8%
    }
</style>

	<div class="card">
		<div class="card-header bg-success text-uppercase text-white text-center mb-2 pt-0" style="height:25px;">
        <h6>Utwórz danie</h6>
		</div>	
        
        
  <form id="CodeSbyAnizForm" asp-action="Create">

  
           <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            
                <label asp-for="NazwaDania" class="control-label"></label>            
           
                <input asp-for="NazwaDania" class="form-control" />
                @*<span asp-validation-for="PoNumber" class="text-danger"></span> *@
           
            
          

            		<div class="col-12 ml-5">
					<table id="TabelaGlowna" class="table table-borderless table-sm mb-0 pb-0">
						<thead>
							<tr>
								<th>
									Nazwa
								</th>
                                <th>
                                   Ilość[g/ml]
                                </th>
								<th>
									Kaloryczność
								</th>
                                <th>
								    Białko
								</th>
                                <th>
								    Tłuszcz 
								</th>
                                <th>
                                    Węglowodany
                                </th>
                                <th>
									Błonnik
								</th>							
                                  <th style="width:60px;">
                                        <button id='btnAddDetailRow' type="button" class="btn btn-sm btn-secondary visible" onclick="AddItem(this)">
                                            Add
                                        </button>
                                   </th>
							</tr>
						</thead>

                    <tbody>                                
                        @for (int i = 0; i < Model.Produkty.Count(); i++)
                        {
                            <tr>
                                <td style="width:30%;">
								    @*<input asp-for="@Model.PoDetails[i].ProductCode" class="form-control" />*@
                                    <select asp-for="@Model.Produkty[i].Nazwa" class="form-control" asp-items="ViewBag.ProduktyLista" onchange="FillValues(this);"></select>
                                </td>
                                    <td class="wlasciwosclisty">
                                        <input asp-for="@Model.Ilosc[i]" class="form-control ilosc_class do_zmiany" />
                                        <span asp-validation-for="@Model.Ilosc[i]" class="text-danger"></span>
									</td>
                                    <td class ="wlasciwosclisty">
										<input asp-for="@Model.Produkty[i].Kaloryczność" class="form-control" readonly/>
										
									</td>
                                    <td class ="wlasciwosclisty">
                                             <input asp-for="@Model.Produkty[i].Białko" class="form-control" readonly/>
                                            
                                     </td >
                                    <td class="wlasciwosclisty">
										<input asp-for="@Model.Produkty[i].Tłuszcz" class="form-control" readonly/>
										
									</td class ="wlasciwosclisty">
                                    <td class ="wlasciwosclisty">
                                        <input asp-for="@Model.Produkty[i].Węglowodany" class="form-control" readonly/>
                                    </td class ="wlasciwosclisty">
                                    <td class ="wlasciwosclisty">
										<input asp-for="@Model.Produkty[i].Błonnik" class="form-control" readonly/>	
                                        <input type="hidden" asp-for="@Model.Produkty[i].IsDeleted" />	
									</td class ="wlasciwosclisty">
                                    <td style="width:60px;">
                                         <button id='btnremove-@i' type="button" class="btn btn-sm btn-danger visible" onclick="CalcTotals()">
                                             Delete
                                        </button>
                                        </td>
                                    </tr>                                
                        }
                    </tbody>

					</table>     
                    <div>
                         <div class="form-group col-12">            
  </div>

  <div class="form-group col-12">            
  </div>
                    </div>
                     <table class="table table-sm mb-0 pb-0 border">
                         <thead>
                            <tr>
                                 <th style="width:30%;">
                                 Suma
                                 </th>	
                             
                                 <th class ="wlasciwosclisty">		
                                     <input type="text" id="ilosc_total" class="form-control form-control-plaintext" value="" />
                                 </th>
                                
                                 <th class ="wlasciwosclisty">									
                                    <input type="text" id="kalorycznosc_total" class="form-control form-control-plaintext" value="" />
                                 </th>
                                    
                                 <th class ="wlasciwosclisty">		
                                     <input type="text" id="bialko_total" class="form-control form-control-plaintext" value="" />
                                 </th>

                                 <th style="width:13%;">	
                                     <input type="text" id="" class="form-control form-control-plaintext" value="" />
                                 </th>                  
                                
                                 <th style="width:13%;">	
                                     <input type="text" id="" class="form-control form-control-plaintext" value="" />
                                 </th>					

                                 <th style="width:13%;">									
                                    <input type="text" id="txtAmountTotal" class="form-control form-control-plaintext" value="" />
                                 </th>					
                                
                                 <th style="width:9%;">                                      
                                 </th>
                            </tr>
 
                            </thead>
                        </table>
                    

				</div>




       
         <div class="form-group btn-group col-12">
                <div class="col-1"></div>
                <div class="col-5">
                    <input type="submit" value="Create" class="btn btn-primary btn-block" />
                </div>           
                <div class="col-5">
                    <a class="btn btn-secondary btn-block" asp-action="MyMeals"
                       asp-route-pg="@TempData.Peek("CurrentPage")">Back</a>
                </div>     
                <div class="col-1"></div>
         </div>



</form>

</div>
@section Scripts {
   <script>

       var myArray = JSON.parse('@Json.Serialize(ViewBag.ProduktyLista)');
       var kalorycznoscArray = JSON.parse('@Json.Serialize(ViewBag.Kalorycznosc)');
       
        
       

        
      function FillValues(item){   
          
          console.log(item)

          var kalorycznosc = kalorycznoscArray.find(function(element) {
        return element.id==item.value;
        });
        console.log(kalorycznosc.kaloryczność)

        document.getElementById('Produkty_0__T_uszcz').value=kalorycznosc.kaloryczność;

        
        
            
      }

        function DeleteItem(btn) {

	   var table = document.getElementById('TabelaGlowna');
	   var rows = table.getElementsByTagName('tr');	           
            
	        var btnIdx = btn.id.replaceAll('btnremove-', '');
            var idOfQuantity = btnIdx + "AAQuantity";
            var txtQuantity = document.querySelector("[id$='" + idOfQuantity + "']");

            txtQuantity.value = 0;
                        

            var idOfIsDeleted = btnIdx + "AAIsDeleted";
            var txtIsDeleted = document.querySelector("[id$='" + idOfIsDeleted + "']");            
            txtIsDeleted.value="true";
                       
            $(btn).closest('tr').hide();

            CalcTotals();


}
        function AddItem(btn) {
            console.log("Create")
            var table;
            table = document.getElementById('TabelaGlowna');
            var rows = table.getElementsByTagName('tr');
            var rowOuterHtml = rows[rows.length - 1].outerHTML;

            var lastrowIdx = rows.length - 2;

            var nextrowIdx = eval(lastrowIdx) + 1;

            rowOuterHtml = rowOuterHtml.replaceAll('_' + lastrowIdx + '_', '_' + nextrowIdx + '_');
            rowOuterHtml = rowOuterHtml.replaceAll('[' + lastrowIdx + ']', '[' + nextrowIdx + ']');
            rowOuterHtml = rowOuterHtml.replaceAll('-' + lastrowIdx, '-' + nextrowIdx);

            var newRow = table.insertRow();
            newRow.innerHTML = rowOuterHtml;

            var x = document.getElementsByTagName("INPUT");

            for (var cnt = 0; cnt < x.length; cnt++) {
                if (x[cnt].type == "text" && x[cnt].id.indexOf('_' + nextrowIdx + '_') > 0) {
                    if (x[cnt].id.indexOf('Unit') == 0)
                        x[cnt].value = '';
                }
                else if (x[cnt].type == "number" && x[cnt].id.indexOf('_' + nextrowIdx + '_') > 0)
                    x[cnt].value = 0;
            }

            
        }



           function CalcTotals() {

            var x = document.getElementsByClassName('ilosc_class');
            //var x = document.getElementsByClassName('QtyTotal');
            //console.log(x)
            var ilosc_total= 0;
            var ilosc_kalorie= 0;
            var ilosc_bialko= 0;
            var ilosc_tluszcz= 0;
            var ilosc_weglowodany= 0;
            var ilosc_blonnik= 0;

            //var totalQty = 0;
            var Amount = 0;
            var totalAmount = 0;
            var txtExchangeRate= 1;
          
            var i;

            for (i = 0; i < x.length; i++) {                                              
                
                var idofIsDeleted = i + "__IsDelete";

                var idofIlosc = "#Ilosc_" + i + '_'  ;                
                
                 
              
                var iloscId = document.querySelector(idofIlosc).id;

                console.log(i)
                                                         



                

                //if (document.getElementById(hidIsDelId).value != "true")
                if(true)
                {
                    console.log(x[i].value);
                    ilosc_total = ilosc_total + eval(x[i].value)
                    
                    //txtprice.value = txtExchangeRate * eval(txtfob.value); 
                            
                    //txttotal.value=eval(x[i].value) * txtprice.value;

                    //totalAmount=eval(totalAmount) + eval(txttotal.value);
                }
            }
            

            document.getElementById('ilosc_total').value = ilosc_total;


            document.getElementById('txtAmountTotal').value = totalAmount.toFixed(2);

            return;
        }

        document.addEventListener('change', function (e) {
            if (event.target.id.indexOf('ProductCode')>=0)
            {
                SetUnitName(event.target);
            }

        },false);

        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('do_zmiany')) 
            {
                CalcTotals();
            } 
        }
        , false);


        </script>
    
}